CreateCollection({name: "Channels"})
CreateCollection({name: "StreamMetrics"})
CreateCollection({name: "ChannelWebhookSubs"})
CreateCollection({name: "TwitchClientAccessTokens"})
CreateCollection({name: "ScheduledTasks"})
CreateCollection({name: "Users" })

CreateIndex({
  name: "Channels_by_login",
  source: Collection("Channels"),
  terms: [
    { field: ["data", "login"]}
  ]
})

CreateIndex({
  name: "ScheduledTasks_by_name",
  source: Collection("ScheduledTasks"),
  terms: [
    { field: ["data", "name"]}
  ]
})

CreateIndex({
  name: "StreamMetrics_by_channelRef",
  source: Collection("StreamMetrics"),
  terms: [
    { field: ["data", "channelRef"] }
  ]
})

CreateRole({
  name: "Guest",
  membership: [
    {
      resource: Collection("Users"),
      predicate: Query(ref =>
        Select(["data", "isGuest"], Get(ref), false)
      )
    }
  ],
  privileges: [
    {resource: Collection("Channels"), actions: {read: true}},
    {resource: Collection("StreamMetrics"), actions: {read: true}},
    {resource: Index("StreamMetrics_by_channelRef"), actions: {read: true}},
  ]
})